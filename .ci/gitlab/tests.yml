.tests:
  image: clashlang/clash-ci:2020-06-29
  stage: build
  timeout: 2 hours
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    TERM: xterm-color
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  cache:
    key: cabal-store-$CI_JOB_NAME
    paths:
      - cabal-store/
  script:
    - unset SNAPCRAFT_LOGIN_FILE
    - unset HACKAGE_PASSWORD
    # Use either ${GHC} or if that's not set, try to detect GHC version by analyzing
    # $CI_JOB_NAME.
    - export GHC="${GHC:-$(echo $CI_JOB_NAME | egrep -o 'ghc-[0-9]+.[0-9]+.[0-9]+')}"
    - export THREADS=$(nproc)
    - export CABAL_JOBS=$(nproc)
    - export
    - .ci/setup.sh
    - .ci/build.sh
    - .ci/test.sh

.tests-interruptible:
  extends: .tests
  interruptible: true
  rules:
    - if: '$CI_COMMIT_BRANCH != "master"'

.tests-non-interruptible:
  extends: .tests
  interruptible: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
